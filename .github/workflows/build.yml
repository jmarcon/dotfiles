name: Validate Dotfiles

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  shellcheck:
    name: ShellCheck (ZSH/Bash)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run ShellCheck on ZSH files
        run: |
          find Config/zsh Install/linux -name "*.zsh" -type f | while read -r file; do
            echo "Checking: $file"
            shellcheck --shell=bash --severity=warning "$file" || true
          done

  powershell-lint:
    name: PSScriptAnalyzer (PowerShell)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install PowerShell
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"
      - name: Install PowerShell via dotnet
        run: dotnet tool install --global PowerShell
      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          $files = Get-ChildItem -Path Config/pwsh,Install/windows -Filter "*.ps1" -Recurse
          $hasErrors = $false
          foreach ($file in $files) {
            Write-Host "Analyzing: $($file.FullName)" -ForegroundColor Cyan
            $results = Invoke-ScriptAnalyzer -Path $file.FullName -Severity Warning,Error
            if ($results) {
              $results | Format-Table -AutoSize
              if ($results | Where-Object Severity -eq 'Error') {
                $hasErrors = $true
              }
            }
          }
          if ($hasErrors) {
            Write-Error "PSScriptAnalyzer found errors"
            exit 1
          }

  syntax-check:
    name: Syntax Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install ZSH
        run: sudo apt-get update && sudo apt-get install -y zsh
      - name: Check ZSH syntax
        run: |
          for file in $(find Config/zsh Install/linux -name "*.zsh" -type f); do
            echo "Syntax check: $file"
            zsh -n "$file" 2>&1 || echo "Warning: $file has syntax issues"
          done
      - name: Check YAML syntax
        run: |
          pip install yamllint
          yamllint -d relaxed .github/workflows/*.yml

  cross-platform-functions:
    name: Cross-Platform Function Sync Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check function parity
        run: |
          echo "=== PowerShell Functions ==="
          grep -rhoE 'function [a-z_]+' Config/pwsh/profile/*.ps1 | sort -u | sed 's/function //' > /tmp/ps_functions.txt
          cat /tmp/ps_functions.txt

          echo ""
          echo "=== ZSH Functions ==="
          grep -rhoE '^function [a-z_]+|^[a-z_]+\(\)' Config/zsh/**/*.zsh | sed 's/function //;s/()//' | sort -u > /tmp/zsh_functions.txt
          cat /tmp/zsh_functions.txt

          echo ""
          echo "=== Function Parity Report ==="
          echo "PowerShell-only functions:"
          comm -23 /tmp/ps_functions.txt /tmp/zsh_functions.txt || echo "(none)"
          echo ""
          echo "ZSH-only functions:"
          comm -13 /tmp/ps_functions.txt /tmp/zsh_functions.txt || echo "(none)"

  neovim-config:
    name: Neovim Config Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Lua
        run: sudo apt-get update && sudo apt-get install -y lua5.4
      - name: Validate Lua syntax
        run: |
          find Config/nvim -name "*.lua" -type f | while read -r file; do
            echo "Checking: $file"
            luac5.4 -p "$file" || echo "Warning: $file has Lua syntax issues"
          done

  tmux-config:
    name: Tmux Config Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Tmux
        run: sudo apt-get update && sudo apt-get install -y tmux
      - name: Validate Tmux config
        run: |
          if [ -f Config/tmux/.tmux.conf ]; then
            echo "Checking tmux config syntax..."
            tmux -f Config/tmux/.tmux.conf start-server \; kill-server 2>&1 || echo "Warning: tmux config may have issues"
          fi
